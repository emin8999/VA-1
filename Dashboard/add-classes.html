<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Add Classes</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --brown: #3b2d2a;
        --muted: #6b6b6b;
      }
      body {
        font-family: Inter, system-ui, Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: #fff7ef;
        color: #2b2b2b;
      }
      h1 {
        font-family: "Playfair Display", serif;
        color: var(--brown);
        margin: 0 0 12px;
      }
      .wrap {
        max-width: 900px;
        margin: 0 auto;
      }
      form {
        display: grid;
        gap: 0.7rem;
        background: #fff;
        border: 1px solid #f0e4db;
        border-radius: 12px;
        padding: 1rem;
      }
      .row {
        display: grid;
        gap: 0.6rem;
      }
      @media (min-width: 700px) {
        .row.two {
          grid-template-columns: 1fr 1fr;
        }
        .row.three {
          grid-template-columns: 1fr 1fr 1fr;
        }
      }
      label {
        display: grid;
        gap: 0.35rem;
        font-size: 0.95rem;
      }
      input,
      select,
      textarea {
        padding: 0.7rem 0.8rem;
        border: 1px solid #e8dcd3;
        border-radius: 10px;
        background: #fff;
      }
      textarea {
        min-height: 110px;
        resize: vertical;
      }
      .btn {
        padding: 0.75rem 1.1rem;
        border-radius: 999px;
        font-weight: 600;
        cursor: pointer;
        border: 2px solid transparent;
      }
      .btn-primary {
        background: linear-gradient(135deg, #fad9c1, #ff8c7a);
        color: #2b1d1a;
      }
      .hint {
        color: var(--muted);
        font-size: 0.9rem;
      }
      .bar {
        display: flex;
        gap: 0.6rem;
        align-items: center;
        justify-content: space-between;
        margin: 0.6rem 0 1rem;
      }
      .bar a {
        color: #2b2b2b;
        text-decoration: none;
        font-weight: 600;
      }
      .ok {
        color: #256c2c;
        font-weight: 600;
        display: none;
      }
      .thumb {
        width: 140px;
        height: 92px;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid #e8dcd3;
        display: none;
      }
      .file-row {
        display: grid;
        gap: 0.5rem;
      }
      @media (min-width: 700px) {
        .file-row {
          grid-template-columns: 1fr auto;
          align-items: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="bar">
        <h1>Добавление классов</h1>
        <a href="classes-list.html">→ Открыть страницу со списком</a>
      </div>

      <form id="classForm">
        <div class="row two">
          <label
            >Название класса
            <input
              type="text"
              id="title"
              placeholder="Балет (Ballet Basics)"
              required
            />
          </label>
          <label
            >Тип (category)
            <select id="type" required>
              <option value="">Выберите…</option>
              <option value="dance">Танцы</option>
              <option value="modeling">Моделинг</option>
              <option value="vocal">Вокал</option>
              <option value="fitness">Фитнес/Гимнастика</option>
            </select>
          </label>
        </div>

        <div class="row two">
          <label
            >Уровень
            <select id="level" required>
              <option value="">Выберите…</option>
              <option value="beginner">Начинающий</option>
              <option value="intermediate">Средний</option>
              <option value="advanced">Продвинутый</option>
            </select>
          </label>
          <label
            >Педагог
            <input type="text" id="teacher" placeholder="Турал" required />
          </label>
        </div>

        <div class="row two">
          <label
            >Расписание
            <input
              type="text"
              id="schedule"
              placeholder="Пн/Ср · 19:00"
              required
            />
          </label>
          <label class="file-row"
            >Картинка (файл)
            <input type="file" id="imageFile" accept="image/*" required />
            <img id="imagePreview" class="thumb" alt="превью" />
          </label>
        </div>

        <label
          >Описание
          <textarea
            id="description"
            placeholder="Экзерсис у станка, постановка корпуса, координация и пластика."
            required
          ></textarea>
        </label>

        <label
          >Теги (через пробел)
          <input type="text" id="tags" placeholder="dance ballet классика" />
          <span class="hint">Эти теги используются для поиска/фильтра</span>
        </label>

        <button class="btn btn-primary" type="submit">Добавить класс</button>
        <span id="okMsg" class="ok">Класс добавлен ✓</span>
      </form>
    </div>

    <script>
      (function () {
        const form = document.getElementById("classForm");
        const okMsg = document.getElementById("okMsg");
        const imgFile = document.getElementById("imageFile");
        const imgPreview = document.getElementById("imagePreview");

        const LEVEL_MAP = {
          beginner: "Начинающий",
          intermediate: "Средний",
          advanced: "Продвинутый",
        };
        const STORAGE_KEY = "academyClasses";
        const bc =
          "BroadcastChannel" in window ? new BroadcastChannel("classes") : null;

        function loadList() {
          try {
            return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
          } catch {
            return [];
          }
        }
        function saveList(list) {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
          if (bc) bc.postMessage({ type: "updated" });
        }

        // Сжатие изображения перед сохранением (уменьшаем до 1600px по большей стороне)
        async function compressImage(
          file,
          { maxW = 1600, maxH = 1600, quality = 0.9 } = {}
        ) {
          // если это не изображение, просто вернём DataURL как есть
          if (!file.type.startsWith("image/")) {
            return await fileToDataURL(file);
          }
          const bmp = await createImageBitmap(file);
          const { width: w, height: h } = bmp;
          const ratio = Math.min(maxW / w, maxH / h, 1);
          const cw = Math.round(w * ratio);
          const ch = Math.round(h * ratio);

          const canvas = document.createElement("canvas");
          canvas.width = cw;
          canvas.height = ch;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(bmp, 0, 0, cw, ch);

          // сохраняем как JPEG (экономим место в localStorage)
          return canvas.toDataURL("image/jpeg", quality);
        }

        function fileToDataURL(file) {
          return new Promise((res, rej) => {
            const r = new FileReader();
            r.onload = (e) => res(e.target.result);
            r.onerror = (e) => rej(e);
            r.readAsDataURL(file);
          });
        }

        // Превью выбранного изображения
        imgFile.addEventListener("change", async (e) => {
          const f = e.target.files?.[0];
          if (!f) {
            imgPreview.src = "";
            imgPreview.style.display = "none";
            return;
          }
          // Для быстрого превью можно показать несжатый DataURL
          const quick = await fileToDataURL(f);
          imgPreview.src = quick;
          imgPreview.style.display = "inline-block";
        });

        form.addEventListener("submit", async (e) => {
          e.preventDefault();

          // Проверки полей
          if (!imgFile.files || !imgFile.files[0]) {
            alert("Пожалуйста, выберите файл изображения.");
            return;
          }

          // Сжимаем и кодируем картинку
          let imageDataUrl = "";
          try {
            imageDataUrl = await compressImage(imgFile.files[0]);
          } catch (err) {
            console.error("Image processing error:", err);
            alert("Не удалось обработать изображение. Попробуйте другой файл.");
            return;
          }

          const item = {
            id: Date.now(),
            title: form.title.value.trim(),
            type: form.type.value,
            level: form.level.value,
            levelName: LEVEL_MAP[form.level.value] || form.level.value,
            teacher: form.teacher.value.trim(),
            schedule: form.schedule.value.trim(),
            image: imageDataUrl, // <— сохраняем Data URL вместо URL
            description: form.description.value.trim(),
            tags: (form.tags.value || "").trim(),
          };

          if (
            !item.title ||
            !item.type ||
            !item.level ||
            !item.teacher ||
            !item.schedule ||
            !item.image ||
            !item.description
          ) {
            alert("Заполни все обязательные поля");
            return;
          }

          const list = loadList();
          list.push(item);
          try {
            saveList(list);
          } catch (err) {
            console.error("Save error:", err);
            alert(
              "Не удалось сохранить. Возможно, размер изображений слишком большой. Попробуйте выбрать фото меньшего размера."
            );
            return;
          }

          // Очистка формы
          form.reset();
          imgPreview.src = "";
          imgPreview.style.display = "none";

          okMsg.style.display = "inline";
          setTimeout(() => (okMsg.style.display = "none"), 2000);
        });
      })();
    </script>
  </body>
</html>
